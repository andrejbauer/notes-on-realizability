\chapter{The category-theoretic structure}
\label{cha:categ-structure}


In Chapter~\ref{chap:realizability} we defined assemblies as our basic
structures of interest. To learn more about them we study which
operations on assemblies are supported by the category $\AsmA$. It
turns out that there is not only a rich collection of constructions
available, but also an interpretation of first-order logic that
assigns to a logical formula its computational meaning.


In their everyday lives mathematicians use a limited set of
constructions on sets: products, disjoint sums, subsets, quotient
sets, images, function spaces, inductive and coinductive definitions,
powersets, unions, intersections, and complements. For all of these,
except powersets, there are analogous constructions of assemblies.
Therefore, if we need a computable version of a given mathematical
structure, may just mimic its set-theoretic definition in the
category of assemblies.

\section{The cartesian structure}
\label{sec:cartesian-structure}

A construction which makes a new set, space, or an algebraic structure
from old ones is usually characterized by a \emph{universal property}
which determines it up to isomorphism. The universal property is
shared among versions of the same construction in different
categories. We start slowly with an easy one, the binary product.

Recall the definition of a \defemph{(binary) product} in a category: the
product of objects $S$ and $T$ is an object $P$ with morphisms $p_1 :
P \to S$ and $p_2 : P \to T$, satisfying the following universal
property: for all morphisms $f : U \to S$ and $g : U \to T$ there is a
unique morphism $h : U \to P$ making the following diagram commute:
%
\begin{equation*}
  \xymatrix@+1em{
    &
    {U}
    \ar[ld]_{f}
    \ar[d]^h
    \ar[rd]^{g}
    &
    \\
    {S}
    &
    {P}
    \ar[l]^{p_1}
    \ar[r]_{p_2}
    &
    {T}
  }
\end{equation*}
%
The products $(P, p_1, p_2)$ is determined uniquely up to a unique
isomorphism. For suppose we had another product $(Q, q_1, q_2)$ of~$S$
and~$T$. By the universal property of $P$ there is a map $h : P \to Q$
such that $p_1 \circ h = q_1$ and $p_2 \circ h = q_2$. Similarly, by
the universal property of~$Q$ there is $k : Q \to P$ such that $q_1
\circ k = p_1$ and $q_2 \circ k = p_2$. Now $h \circ k$ satisfies
%
\begin{equation*}
  p_1 \circ h \circ k = q_1 \circ k = p_1
  \qquad\text{and}\qquad
  p_2 \circ h \circ k = q_2 \circ k = p_2.
\end{equation*}
%
Since $\id_P$ also satisfies $p_1 \circ \id_P = p_1$ and $p_2 \circ
\id_P = p_2$, it follows by the uniqueness condition of the universal
property that $h \circ k = \id_P$. A similar argument shows that $k
\circ h = \id_Q$, hence $P$ and $Q$ are isomorphic.

A category \defemph{has binary products} if every pair of objects has a
binary product. In most cases we can actually provide an operation
$\times$ which maps a pair of objects $S$, $T$ to a specifically given
product $S \times T$ with corresponding projections. The unique map
$h$ determined by $f$ and $g$ is denoted by $\pair{f,g}$.

In the category~$\Set$ the product is just the usual cartesian product
of sets. In assemblies we need to worry about the underlying types and
realizability relations. Let us verify that the product of assemblies
$\asm{S}$ and $\asm{T}$ is the assembly
%
\begin{equation*}
  \asm{S} \times \asm{T} =
  (S \times T, |S| \times |T|, {\rz_{S \times T}})
\end{equation*}
%
with the realizability relation
%
\begin{equation*}
  \combPair\;q\;r \rz_{S \times T} (x,y)
  \iff
  q \rz_S x
  \land
  r \rz_T y.
\end{equation*}
%
and the projection maps $\pi_1 : S \times T \to S$, $\pi_1 : (x,y)
\mapsto x$, and $\pi_2 : S \times T \to T$, $\pi_2 : (x,y) \mapsto y$,
which are realized by $\combFst$ and $\combSnd$, respectively.
%
To see that $(\asm{S} \times \asm{T}, \pi_1, \pi_2)$ has the universal
property, suppose $f : \asm{U} \to \asm{S}$ and $g : \asm{U} \to
\asm{T}$ are realized by $\R{f} \in \comp{A}_{|U| \to |S|}$ and $\R{g}
\in \comp{A}_{|U| \to |T|}$, respectively. There is a unique map $h :
U \to S \times T$ for which $f = \pi_1 \circ h$ and $g = \pi_2 \circ g$,
namely $h(u) = \pair{f,g}(u) = (f(u), g(u))$. We only need a realizer
for~$h$, and $\R{h} =
\pcalam{\annot{u}{|U|}}{\combPair\;(\R{f}\;u)\;(\R{g}\;u)}$ does the
job:
%
\begin{multline*}
  \R{u} \rz_U u
  \implies
  \R{f}\;\R{u} \rz_S f(u)
  \land
  \R{g}\;\R{u} \rz_T g(u)
  \implies {} \\
  \combPair\; (\R{f}\;\R{u})\; (\R{g}\;\R{u}) \rz_{S \times T} (f(u), g(u))
  \iff
  \R{h}\;\R{u} \rz_{S \times T} h(u).
\end{multline*}

Once we have binary products we may form $n$-ary products $S_1 \times
\cdots \times S_n$ for $n \geq 1$ by repeatedly forming binary
products. The case $n = 0$ corresponds to the \defemph{terminal object},
which is an object $\one$ such that for every object~$S$ there is
exactly one morphism $S \to \one$. In the category of sets the
terminal object is (any) singleton set, say $\one = \set{\star}$. Then
$\nabla \one$ is the terminal assembly, since for any assembly
$\asm{S}$ the only map $S \to \one$ is realized. We denote the
terminal assembly as $\one$.

We may also ask whether $\AsmA$ has infinite products. The answer
depends on the underlying TPCAs $(\AA, \compAA)$. We state without
proof that $\Asm{\Scott, \comp{\Scott}}$ and $\Asm{\Baire,
  \comp{\Baire}}$ have countable products, whereas $\Asm{\NN}$ does
not.

Products are a special case of categorical limits. Two other common
kinds of limits are equalizers and pullbacks. An \defemph{equalizer} of a
pair of morphisms $f, g : S \to T$ is an object $E$ with a morphism $e
: E \to S$ such that $e$ equalizes $f$ and $g$, which means that $f
\circ e = g \circ e$, and the following universal property is
satisfied: if $k : K \to S$ also equalizes $f$ and $g$ then there
exists a unique morphism $i : K \to E$ such that $k = e \circ i$:
%
\begin{equation*}
  \xymatrix@+1em{
    {E}
    \ar[r]^{e}
    &
    {S}
    \ar@<+0.25em>[r]^{f}
    \ar@<-0.25em>[r]_{g}
    &
    {T}
    \\
    {K}
    \ar[u]^{i}
    \ar[ru]_{k}
    & & 
  }
\end{equation*}
%
Think of $E$ as the solution-set of equation $f(x) =
g(x)$.\sidenote{If we have a system of equations $f_i(x) = g_i(x)$, $i
  = 1, \ldots, n$, then we may express them as a single vector
  equation $f(x) = g(x)$ where $f(x) = (f_1(x), \ldots, f_n(x))$ and
  $g(x) = (g_1(x), \ldots, g_n(x))$. Equalizers are thus an abstract
  formulation of the notion ``solution of a system of equations''.}
Indeed, in the category of sets the equalizer of functions $f, g : S
\to T$ is the subset $E = \set{x \in S \such f(x) = g(x)}$ and $e : E
\to S$ is the subset inclusion. In the category of assemblies we need
to augment this with realizers. The equalizer of $f, g : \asm{S} \to
\asm{T}$ is
%
\begin{equation}
  \label{eq:asm-equalizer}%
  \asm{E} =
  (\set{x \in S \such f(x) = g(x)},
   |S|,
   {\rz_E})
\end{equation}
%
where $\R{x} \rz_E x$ if, and only if, $\R{x} \rz_S x$. The map $e : E
\to S$ is the subset inclusion, $e(x) = x$. It is realized by
$\xpcalam{\annot{x}{|S|}}{x}$. Clearly, $e$ equalizes~$f$ and~$g$. We
leave the verification of the universal property as exercise.

A \defemph{pullback}, sometimes called \defemph{fibered product}, is a
combination of product and equalizer. Given morphisms $f : S \to U$
and $g : T \to U$, the pullback of $f$ and $g$ is an object $P$ with
morphisms $p_1 : P \to S$ and $p_2 : P \to T$ such that $f \circ p_1 =
g \circ p_2$. Furthermore, if $q_1 : Q \to S$ and $q_2 : Q \to T$ are
such that $f \circ q_1 = g \circ q_2$ then there is a unique $i : Q
\to P$ which makes the following diagram commute:
%
\begin{equation*}
  \xymatrix@+0.5em{
    {Q}
    \ar[dr]^{i}
    \ar@/_1em/[ddr]_{q_2}
    \ar@/^1em/[rrd]^{q_1}
    &
    &
    \\
    &
    {P} \pbcorner
    \ar[r]^{p_1}
    \ar[d]_{p_2}
    &
    {S}
    \ar[d]^{f}
    \\
    &
    {T}
    \ar[r]_{g}
    &
    {U}
  }
\end{equation*}
%
The fact that $P$ is a pullback is traditionally marked in a diagram
with the ``corner'' symbol. In the category of assemblies the pullback
of $f : \asm{S} \to \asm{U}$ and $g : \asm{T} \to \asm{U}$ is the
assembly
%
\begin{equation*}
  \asm{P} = (\set{(x,y) \in S \times T \such f(x) = g(y)}, |S| \times
  |T|, {\rz_P})
\end{equation*}
%
where $\combPair\;\R{x}\;\R{y} \rz_P (x,y)$ if, and only if, $\R{x}
\rz_S x$ and $\R{y} \rz_T y$.

Finite products, the terminal object, equalizers, and pullbacks are
special cases of \defemph{finite limits}. A category which has all finite
limits is called \defemph{cartesian} or \defemph{finitely
  complete}.\sidenote{We do not like much the still older terminology
  \emph{left exact} or just \emph{lex}.}

\begin{proposition}
  \label{prop:asm-cartesian}%
  The categories $\AsmA$ and $\Mod{\AA, \compAA}$ are cartesian.
\end{proposition}

\begin{proof}
  It is well known that every finite limit may be constructed as a
  combination of a finite product and an equalizer, hence $\AsmA$ is
  cartesian. It is easy to verify that finite products and equalizers
  of modest assemblies are again modest, therefore $\Mod{\AA,
    \compAA}$ is cartesian.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Cocartesian structure}
\label{sec:cocartesian-structure}


Colimits are the dual of limits. In particular, the dual of products,
terminal object, equalizers, and pullbacks are respectively
coproducts, initial object, coequalizers, and pushouts. We study which
of these exist in~$\AsmA$.

First we discuss (binary) coproducts of sets, also known as disjoint
sums. For some reason there does not seem to be a well-established and
practical notation for these, possibly because the related union
operation is taken as primitive in set theory. The disjoint sum of
sets~$S$ and~$T$ is usually defined as
%
\begin{equation*}
  S + T = (\set{0} \times S) \cup (\set{1} \times T).
\end{equation*}
%
The canonical injections $\iota_1 : S \to S + T$ and $\iota_2 : T \to
S + T$ are the maps $x \mapsto (0,x)$ and $y \mapsto (1,x)$,
respectively. A slight notational inconvenience arises when want to
define a map $f : S + T \to U$ by cases $f_1 : S \to U$ and $f_2 : T
\to U$. One possibility is to write
%
\begin{equation*}
  f(u) =
  \begin{cases}
    f_1(x) & \text{if $u = (0,x)$,}\\
    f_2(y) & \text{if $u = (1,y)$,}
  \end{cases}
\end{equation*}
%
but this is seen rarely. In practice mathematicians prefer to assume,
or shall we say \emph{pretend}, that the sets~$S$ and~$T$ are disjoint
and just write $S + T = S \cup T$. This allows us to get rid of the
encoding by pairs,
%
\begin{equation*}
  f(u) =
  \begin{cases}
    f_1(u) & \text{if $u \in S$,}\\
   f_2(u) & \text{if $u \in T$.}
  \end{cases}
\end{equation*}
%
Unlike people, computers do not pretend, and so as computer scientists
we need notation that is actually correct. However, it is unnecessary
to write the elements of a disjoint sum as uninformative pairs $(0,x)$
and $(1,y)$. Instead, we simply take the injections $\iota_1$ and
$\iota_2$ as \emph{labels} that indicate which part of a disjoint sum
we are referring to. Thus, every element of $S + T$ is either of the
form $\iota_1(x)$ for a unique $x \in S$, or $\iota_2(y)$ for a unique
$y \in T$.\sidenote{If you feel the urge to really encode everything
  with sets, you can still define $\iota_1(x) = (0, x)$ and
  $\iota_2(y) = (1, y)$ but then forget the definition.} In a specific
case we may choose different, descriptive names for the injections.

Definition by cases is a primitive concept involving disjoint sums
which deserves its own notation, preferably one that fits on a single
line. We may mimic Haskell and write
%
\begin{equation*}
  \case{e}{\iota_1(x)}{e_1}{\iota_2(y)}{e_2}.
\end{equation*}
%
Read this as ``if $e$ is of the form $\iota_1(x)$ then $e_1$, else if
$e$ is of the form $\iota_2(y)$ then $e_2$''. The variables $x$ and
$y$ are bound in $e_1$ and $e_2$, respectively. The definition of $f$
above would be written as
%
\begin{equation*}
  f(u) = \case{u}{\iota_1(x)}{f_1(x)}{\iota_2(y)}{f_2(y)},
\end{equation*}
%
or spanning several lines
%
\begin{equation*}
  f(u) = \xcase{u}{\iota_1(x)}{f_1(x)}{\iota_2(y)}{f_2(y).}
\end{equation*}
%
We shall use this notation. Let us mention that in Haskell $\iota_1$
and $\iota_2$ are called $\mathtt{Left}$ and $\mathtt{Right}$,
respectively.

In a general category a \defemph{(binary) coproduct} of objects~$S$
and~$T$ is an object $C$ with morphisms $\iota_1 : S \to C$ and
$\iota_2 : T \to C$ such that, for all morphisms $f : S \to U$ and $g
: T \to U$ there exists a unique $h : C \to U$ such that the following
diagram commutes:
%
\begin{equation*}
  \xymatrix@+1em{
    &
    {U}
    &
    \\
    {S}
    \ar[r]_{\iota_1}
    \ar[ru]^{f}
    &
    {C}
    \ar[u]^{h}
    &
    {T}
    \ar[l]^{\iota_2}
    \ar[lu]_{g}
  }
\end{equation*}
%
Notice that we have exactly reversed all the morphisms with respect to
the definition of products. We write the coproduct of $S$ and $T$ as
$S + T$ when it is given as an operation, and the unique morphism~$h$
as~$[f,g]$.

Whether assemblies $\AsmA$ have binary coproducts is an interesting
question. The answer seems to depend on the structure of the
underlying TPCAs.

\begin{definition}
  A TPCA~$\AA$ with \defemph{sums} is a TPCA with a binary operation $+$
  on the types such that, for all types $s$, $t$, and $u$ there exist
  constants
  %
  \begin{align*}
    \combLeft_{s,t} &\in \Atyp{s \to (s + t)} \\
    \combRight_{s,t} &\in \Atyp{t \to (s + t)} \\
    \combCase_{s,t,u} &\in \Atyp{(s + t) \to (s \to u) \to (t \to u) \to u}
  \end{align*}
  %
  satisfying, for all $x$, $y$, $f$, $g$ of appropriate types,
  %
  \begin{align*}
    \defined{\combLeft_{s,t}\;x} &, \\
    \defined{\combRight_{s,t}\;y} &,\\
    \combCase_{s,t,u}\;(\combLeft_{s,t}\;x)\;f\;g &\klgeq f\;x, \\
    \combCase_{s,t,u}\;(\combRight_{s,t}\;y)\;f\;g &\klgeq g\;y.
  \end{align*}
  %
  We say that the elements $\combLeft$, $\combRight$, and $\combCase$
  are \emph{suitable} for sums when they satisfy these properties.

  A \defemph{sub-TPCA with sums} is a sub-TPCA $\compAA$ of~$\AA$ such
  that there exists $\combLeft$, $\combRight$, $\combCase$
  in~$\compAA$ suitable for sums in $\AA$.
\end{definition}

\begin{proposition}
  \label{prop:asm-coproducts-iff-tpca-sums}
  Suppose $\AA$ is a TPCA and $\compAA$ its sub-TPCA. The category
  $\AsmA$ has binary coproducts if, and only if, $\AA$ is a TPCA with
  sums and $\compAA$ is its sub-TPCA with sums.
\end{proposition}

\begin{proof}
  Suppose first that $\AA$ has sums and that $\compAA$ is a sub-TPCA
  with sums. The coproduct of $\asm{S}$ and $\asm{T}$ is the assembly
  %
  \begin{equation*}
    \asm{S} + \asm{T} = (S + T, |S| + |T|, \rz_{S + T})
  \end{equation*}
  %
  where $\rz_{S+T}$ is most easily defined in terms of the existence
  predicate $\Ex_{S+T}$:
  %
  \begin{equation*}
    \Ex_{S+T}(u) =
    \xcase{u}
    {\iota_1(x)}{\set{\combLeft\;\R{x} \such \R{x} \rz_S x}}
    {\iota_2(y)}{\set{\combRight\;\R{y} \such \R{y} \rz_T y}.}
  \end{equation*}
  %
  That is, the realizers for $\iota_1(x)$ are of the form
  $\combLeft\;\R{x}$ where $\R{x} \rz_S x$, and the realizers for
  $\iota_2(y)$ are of the form $\combRight\;\R{y}$ where $\R{y} \rz_T
  y$. The canonical inclusions $\iota_1 : S \to S + T$ and $\iota_2 :
  T \to S + T$ are realized by $\combLeft_{|S|,|T|}$ and
  $\combRight_{|S|,|T|}$, respectively.
  %
  To see that $\asm{S} + \asm{T}$ has the required universal property,
  consider $f : \asm{S} \to \asm{U}$ and $g : \asm{T} \to \asm{U}$,
  realized by $\R{f}$ and $\R{g}$, respectively. The map $h = [f,g] :
  S + T \to U$, defined by
  %
  \begin{equation*}
    h(u) = \case{u}{\iota_1(x)}{f(x)}{\iota_2(y)}{g(y)},
  \end{equation*}
  %
  is realized by
  $\pcalam{\annot{u}{|S|+|T|}}{\combCase\;u\;\R{f}\;\R{g}}$. It is the
  unique morphism satisfying $h \circ \iota_1 = f$ and $h \circ
  \iota_2 = g$.

  Conversely, suppose $\AsmA$ has binary coproducts. For every type
  $t$, define the assembly
  %
  \begin{equation*}
    \asm{A}_t = (\Atyp{t}, t, {\rz_t})
  \end{equation*}
  %
  with $r \rz_t q \iff r = q$. For types $s$ and $t$ let $s+t$ be the
  underlying type of the coproduct $\asm{A}_s + \asm{A}_t$,
  %
  \begin{equation*}
    s + t = |\asm{A}_s + \asm{A}_t|.
  \end{equation*}
  %
  Let $\combLeft_{s,t}$ and $\combRight_{s,t}$ be a realizers for the
  canonical inclusions $\iota_1 : \asm{A}_s \to \asm{A}_s + \asm{A}_t$
  and $\iota_2 : \asm{A}_t \to \asm{A}_s + \asm{A}_t$, respectively.

  Suppose $s$, $t$, and $u$ are types. Define $a \in \compAA_{s \to (s
    \to u) \to (t \to u) \to u}$ and $b \in \compAA_{t \to (s \to u)
    \to (t \to u) \to u}$ by
  %
  \begin{equation*}
    a = \pcalam{\annot{x}{s}
                 \annot{f}{s \to u}
                 \annot{g}{t \to u}}
                 {f\;x}
   \qquad\text{and}\qquad
    b = \pcalam{\annot{x}{s}
                 \annot{f}{s \to u}
                 \annot{g}{t \to u}}
                 {g\;x}.
  \end{equation*}
  %
  The map $x \mapsto a\;x$ is a morphism from $\asm{A}_s$ to
  $\asm{A}_{(s \to u) \to (t \to u) \to u}$ because it is realized
  by~$a$. Similarly, the map $y \mapsto b\;y$ is a morphism from
  $\asm{A}_t$ to $\asm{A}_{(s \to u) \to (t \to u) \to u}$, realized
  by~$b$. There is a unique morphism $h : \asm{A}_s + \asm{A}_t \to
  \asm{A}_{(s \to u) \to (t \to u) \to u}$ such that $h(\iota(x)) =
  a\;x$ and $h(\iota(y)) = b\;y$ for all $x \in \asm{A}_s$ and $y \in
  \asm{A}_t$. There exists
  %
  \begin{equation*}
    \combCase_{s,t,u} \in \compAtyp{(s+t) \to (s \to u) \to (t \to u) \to u}
  \end{equation*}
  %
  which realizes~$h$. We claim that $\combLeft_{s,t}$,
  $\combRight_{s,t}$, and $\combCase_{s,t,u}$ have the desired
  properties. It is obvious that $\defined{\combLeft_{s,t}\;x}$ and
  $\defined{\combRight_{s,t}\;y}$ for all $x \in \Atyp{s}$, $y \in
  \Atyp{t}$. Next, because $\combCase_{s,t,u}$ realizes $h$,
  $\combLeft_{s,t}$ realizes $\iota_1$, and $h(\iota_1(x)) = a\;x$, we
  have $\combCase_{s,t,u}\;(\combLeft_{s,t}\;x) = a\;x$, therefore
  %
  \begin{equation*}
    \combCase_{s,t,u}\;(\combLeft_{s,t}\;x)\;f\;g \kleq
    a\;x\;f\;g \kleq f\;x
  \end{equation*}
  %
  for all $x$, $f$, and $g$ of relevant types. Similarly,
  $\combCase_{s,t,u}\;(\combRight_{s,t}\;y)\;f\;g \kleq g\;y$ holds
  as well.
\end{proof}

The obvious question to ask is when a TPCA has sums. We do not know
whether there is a TPCA without sums, and we do not explore the
question further. We satisfying ourselves with a sufficient condition
that covers the instances we care about.

\begin{definition}
  \label{def:tpca-booleans}%
  A TPCA $\AA$ has \defemph{booleans} when there is a type $\ttbool$, and
  for each type~$t$ elements
  %
  \begin{equation*}
    \combFalse, \combTrue \in \Atyp{\ttbool}
    \qquad\text{and}\qquad
    \combIf_t \in \Atyp{\ttbool \to t \to t \to t}
  \end{equation*}
  %
  satisfying, for all $x, y \in \Atyp{t}$,
  %
  \begin{equation*}
    \combIf_t\;\combTrue\;x\;y = x
    \qquad\text{and}\qquad
    \combIf_t\;\combFalse\;x\;y = y.
  \end{equation*}
  %
  We say that $\combFalse$, $\combTrue$, $\combIf_t$ are
  \emph{suitable} for booleans in~$\AA$.

  A sub-TPCA with booleans is a sub-TPCA $\compAA$ of~$\AA$ such that
  there exists $\combFalse$, $\combTrue$, $\combIf_t$ in $\compAA$
  which are suitable for booleans in~$\AA$.
\end{definition}


\begin{proposition}
  \label{prop:tpca-sums-iff-booleans}
  A TPCA $\AA$ has sums if, and only if, it has booleans. Furthermore,
  a sub-TPCA~$\compAA$ is a sub-TPCA with sums if, and only if, it is
  a sub-TPCA with booleans.
\end{proposition}

\begin{proof}
  Suppose $\AA$ has sums. Pick any type $o$, an element $\omega_o \in
  \Atyp{o}$, and define
  %
  \begin{align*}
    \ttbool &= o + o, \\
    \combTrue &= \combLeft\;\omega_o, \\
    \combFalse &= \combRight\;\omega_o \\
    \combIf_t &= \pcalam{\annot{b}{\ttbool}
                         \annot{x}{t}
                         \annot{y}{t}}
                        {\combCase_{o,t,t}\;b\;(\combK_{o,t}\;x)\;(\combK_{o,t}\;y)}
  \end{align*}
  %
  It is easy to check that these satisfy the conditions from
  Definition~\ref{def:tpca-booleans}.

  Conversely, suppose $\AA$ has booleans, and let $s$, $t$, and $u$ be
  types. There exist $\omega_s \in \Atyp{s}$ and $\omega_t \in
  \Atyp{t}$. Define
  %
  \begin{align*}
    s + t &= \ttbool \times (s \times t),\\
    \combLeft_{s,t} &=
    \pcalam{\annot{x}{s}}{\combPair\;\combTrue\;(\combPair\;x \; \omega_t)} \\
    \combRight_{s,t} &=
    \pcalam{\annot{y}{t}}{\combPair\;\combFalse\;(\combPair \; \omega_s \; y)} \\
    \combCase_{s,t,u} &=
    \pcalam{\annot{z}{s+t}
            \annot{f}{s \to u}
            \annot{g}{s \to u}}
    {\combIf\;(\combFst\;z)\;(f\;(\combFst\;(\combFst\;z)))\;(g\;(\combSnd\;(\combFst\;z)))}
  \end{align*}
  %
  These have the required properties, as is easily checked.
\end{proof}

\begin{proposition}
  \label{prop:n-tpca-booleans}
  Every N-TPCA has booleans and every sub-N-TPCA is a sub-N-TPCA with
  booleans.
\end{proposition}

\begin{proof}
  Let $\AA$ be a N-TPCA and $\compAA$ its sub-N-TPCA. Define
  %
  \begin{align*}
    \ttbool &= \ttnat, \\
    \combFalse &= \numeral{0}, \\
    \combTrue &= \numeral{1}, \\
    \combIf_t &= \pcalam{\annot{b}{\ttbool}
                         \annot{x}{t}
                         \annot{y}{t}}{
                         \combRec_t \; y \;
                         (\xpcalam{\annot{n}{\ttnat} \annot{z}{t}}{x}) \; b 
                       }
  \end{align*}
  %
  Again, it is easy to check that these have the desired properties.
\end{proof}

\noindent
Finally, let us put all these together.

\begin{proposition}
  If $\AA$ is a N-TPCA and $\compAA$ its sub-N-TPCA then $\AsmA$ has
  binary coproducts.
\end{proposition}

\begin{proof}
  Combine Propositions~\ref{prop:asm-coproducts-iff-tpca-sums},
  \ref{prop:tpca-sums-iff-booleans}, and \ref{prop:n-tpca-booleans}.
\end{proof}

The other finite colimits are more easily dealt with. The initial
object is the \defemph{empty assembly}
%
\begin{equation*}
  \zero = (\emptyset, o, \rz_\zero)
\end{equation*}
%
where $o$ is any type.\sidenote{If you are wondering what $\rz_\zero$
  is, ask yourself how many relations there are between $\Atyp{o}$ and
  $\emptyset$.} Its universal property is that there is exactly one
morphism $\zero \to \asm{S}$ for every assembly~$\asm{S}$. The
property holds because there is a unique map $\emptyset \to S$, which
is realized by $\combK_{|S|,o}\;a$, where $a \in \compAtyp{o}$.

A \defemph{coequalizer} of morphisms $f, g : S \to T$ is an object $Q$
with a morphism $q : T \to Q$ that equalizes~$f$ and $g$, which means
$q \circ f = q \circ g$, and has the following universal property: if
$k : T \to K$ equalizes~$f$ and~$g$ then there is a unique morphism $i
: Q \to K$ such that $k = i \circ q$:
%
\begin{equation*}
  \xymatrix@+1em{
    {S}
    \ar@<+0.25em>[r]^{f}
    \ar@<-0.25em>[r]_{g}
    &
    {T}
    \ar[rd]_{k}
    \ar[r]^{q}
    &
    {Q}
    \ar[d]^{i}
    \\
    & & 
    {K}
  }
\end{equation*}
%
In the category of sets the coequalizer is the quotient $Q =
T/{\equiv}$ of~$T$ by the least equivalence relation~$\equiv$
satisfying $f(x) \equiv g(x)$ for all $x \in S$. The map $q : T \to
T/{\equiv}$ is the canonical quotient map which takes $y \in T$ to its
equivalence class $[y]_{\equiv}$.

In $\AsmA$ the coequalizer of $f, g : \asm{S} \to \asm{T}$ is the
assembly $\asm{T}/{\equiv}$ where $T/{\equiv}$ is the coequalizer of
$f$ and $g$ computed in sets, as described above, $|\asm{T}/{\equiv}|
= |T|$, and $\rz_{T/{\equiv}}$ is defined by
%
\begin{equation*}
  \R{y} \rz_{T/{\equiv}} [z]_{\equiv} \iff
  \xsome{y}{T}{\R{y} \rz_T y \land y \equiv z}.
\end{equation*}
%
The canonical quotient map $q : T \to T/{\equiv}$ is realized by
$\xpcalam{\annot{y}{|T|}}{y}$.

Pushouts, which are dual to pullbacks, exist in~$\AsmA$ if coproducts
do, because every finite colimit is a coequalizer of a finite
coproduct, as recorded in the following proposition. We leave an
explicit description of pushouts as exercise.

\begin{proposition}
  \label{prop:asm-cocartesian}%
  $\AsmA$ is cocartesian\sidenote{A category is \defemph{cocartesian} or
    \defemph{finitely cocomplete} if it has finite colimits.} if, and
  only if, $\AA$ is a TPCA with sums and $\compAA$ a sub-TPCA with
  sums.
\end{proposition}

\begin{proof}
  Coequalizers and the initial object always exist. Therefore, all
  finite colimits exist, provided binary coproducts do. By
  Proposition~\ref{prop:asm-coproducts-iff-tpca-sums} this is
  equivalent to the condition that $\AA$ have sums and $\compAA$ be a
  sub-TPCA with sums.
\end{proof}


\section{Monos and epis}
\label{sec:monos-epis}

Recall that $f$ is a \defemph{monomorphism (mono)} when it can be
canceled on the left: if $f \circ g = f \circ h$ then $g = h$. The
dual notion is \defemph{epimorphism (epi)}, which is a morphism that can
be canceled on the right. In the category of sets the monos and epis
are precisely the injective and surjective maps, respectively.

\begin{proposition}
  \label{prop:asm-mono-epi-when}%
  A morphism in $\AsmA$ is mono if, and only if, it is mono as a map
  in $\Set$, and likewise for epis.
\end{proposition}

\begin{proof}
  It is obvious that a morphism $f : \asm{S} \to \asm{T}$ is a mono in
  $\AsmA$ if it is mono in $\Set$. Conversely, suppose $f$ is mono in
  $\AsmA$, and consider maps $g, h : U \to T$ in $\Set$ such that $f
  \circ g = f \circ h$. Define the assembly $\asm{U} = (U, |S| \times
  |S|, {\rz_U})$ with the realizability relation
  % 
  \begin{equation*}
    \combPair\;\R{x}\;\R{y} \rz_U u
    \iff \R{x} \rz_S f(u) \land \R(y) \rz_S g(u).
  \end{equation*}
  % 
  The maps $g$ and $h$ are morphisms from $\asm{U}$ to $\asm{S}$
  because they are realized by $\combFst$ and $\combSnd$,
  respectively. Since $f$ is mono as a morphism of assemblies, it
  follows that $g = h$.

  Next we consider epis. Again, it is easy to see that a morphism $f :
  \asm{S} \to \asm{T}$ is epi if it is epi in $\Set$. Conversely,
  suppose~$f$ is epi in $\AsmA$ and consider maps $g, h : T \to U$
  in~$\Set$ such that $g \circ f = h \circ f$. The maps $g$ and $h$
  are morphisms $T \to \nabla U$ because they are realized by
  $\combK_{|S|,|\nabla U|} a$ respectively, where $a \in
  \compAtyp{|\nabla U|}$. Since $f$ is epi in $\AsmA$, we may cancel
  it and obtain $g = h$. This shows that $f$ is epi in~$\Set$.
\end{proof}

A \defemph{mono-epi} is a morphism $f : S \to T$ which is both mono and
epi. In general such a morphism need not be an isomorphism. For
example, a continuous bijection between topological spaces need not be
a homeomorphism.

\begin{corollary}
  A realized map $f : \asm{S} \to \asm{T}$ is mono-epi if, and only
  if, it is is bijective.
\end{corollary}

\begin{proof}
  This follows directly from Proposition~\ref{prop:asm-mono-epi-when}
  and the fact that in $\Set$ an epi-mono is the same thing as a
  bijection.
\end{proof}

It is easy to provide an epi-mono which is not an isomorphism. For
example if $\asm{S}$ is a modest set with at least two different
elements, then $\id_S : S \to S$ is realized as a morphism $\id_S :
\asm{S} \to \nabla S$, hence it is an epi-mono in $\AsmA$. However,
every morphism $\nabla S \to \asm{S}$ is a constant map, therefore
$\asm{S}$ is not isomorphic to~$\nabla{S}$.

Recall that $f : \asm{S} \to \asm{T}$ is a \defemph{regular mono} if
there are $g, h : \asm{T} \to \asm{U}$ such that~$f$ is their
equalizer. Regular monos are well behaved, and we can think of them as
subspace embeddings. Given an assembly $\asm{T}$ and a subset $T'
\subseteq T$, define the assembly $\asm{T}' = (T', |T|, {\rz_{T'}})$
as the restriction of $\asm{T}$, i.e., $\R{x} \rz_{T'} x$ if, and only
if $x \in T'$ and $\R{x} \rz_T x$. The subset inclusion $\iota : T'
\to T$ is a morphism of assemblies because it is realized by
$\xpcalam{\annot{x}{|T|}}{x}$, and it is a regular mono because it is
the equalizer of the maps $g, h : T \to \nabla \two$, defined by
%
\begin{equation*}
  g(x) = 1
  \qquad\text{and}\qquad
  h(x) =
  \begin{cases}
    1 & \text{if $x \in T'$,}\\
    0 & \text{otherwise}.
  \end{cases}
\end{equation*}
%
Even more, every regular mono is of this form, up to isomorphism. To
see this, suppose $f : \asm{S} \to \asm{T}$ is a regular mono, thus an
equalizer of morphisms $g, h : \asm{T} \to \asm{U}$. If we simply
compute the equalizer of $g$ and $h$ again according to the
recipe~\eqref{eq:asm-equalizer} from
Section~\ref{sec:cartesian-structure}, we see that it is precisely the
restriction of $\asm{T}$ to the subset
% 
\begin{equation*}
  T' = \set{x \in T \such g(x) = h(x)}.
\end{equation*}
% 
Since both $\iota : \asm{T}' \to \asm{T}$ and $f : \asm{S} \to
\asm{T}$ are equalizers of $g$ and $h$, they are isomorphic.

The following characterization of regular monos is often useful.

\begin{proposition}
  \label{prop:reg-mono-when}%
  A realized map $f : \asm{S} \to \asm{T}$ is a regular mono if, and
  only if, $f$ is injective and there exists $\R{i} \in \compAtyp{|T|
    \to |S|}$ such that, for all $x \in S$ and $\R{y} \in \Atyp{|T|}$,
  if $\R{y} \rz_T f(x)$ then $\R{i}\;\R{y}$ is defined and
  $\R{i}\;\R{y} \rz_S x$.
\end{proposition}

\begin{proof}
  A regular mono $f : \asm{S} \to \asm{T}$ is injective because it is
  mono. There exist realized maps $g, h : \asm{T} \to \asm{U}$ such
  that~$f$ is their equalizer. Let $e : \asm{E} \to \asm{T}$ be the
  equalizer of~$g$ and~$h$, as computed in~\eqref{eq:asm-equalizer}:
  %
  \begin{align*}
    \asm{E} &= (\set{y \in T \such g(y) = h(y)}, |T|, {\rz_E}), \\
    \R{y} \rz_E y &\iff \R{y} \rz_T y, \\
    e(y) &= y.
  \end{align*}
  %
  Because $e$ equalizes $g$ and $h$, there is a realized map $i :
  \asm{E} \to \asm{S}$ such that $e = f \circ i$. We claim that any
  realizer $\R{i} \in \compAtyp{|T| \to |S|}$ of~$i$ has the desired
  property. Suppose $x \in S$, $\R{y} \in \Atyp{|T|}$, and $\R{y}
  \rz_T f(x)$. Because $g(f(x)) = h(f(x))$, $f(x) \in E$ and so $\R{y}
  \rz_E f(x)$. Then $\R{i}\;\R{y}$ is defined and $\R{i}\;\R{y} \rz_S
  i(f(x))$. This is what we want because $f(i(f(x))) = e(f(x)) =
  f(x)$, from which $i(f(x)) = x$ follows by injectivity of~$f$.

  Conversely, suppose $f : \asm{S} \to \asm{T}$ is injective, realized
  by~$\R{f}$, and $\R{i}$ is as in statement of the proposition. Let
  $T' = \set{y \in T \such \xsome{x}{S}{f(x) = y}}$. It suffices to
  show that $f$ is isomorphic to the inclusion $\iota : \asm{T}' \to
  \asm{T}$, where $\asm{T}'$ is the restriction of~$\asm{T}$ to $T'$.
  The map $j : \asm{S} \to \asm{T}'$ defined by $j(x) = f(x)$ is
  realized by $\R{f}$. The map $i : \asm{T}' \to \asm{S}$, defined by
  $i(f(x)) = x$, is well defined because~$f$ is injective, and is
  realized by $\R{i}$. Clearly, $j$ and $i$ are inverses of each other
  and $f = \iota \circ j$.
\end{proof}


We repeat the story for \defemph{regular epis}, which are those morphisms
that are coequalizers. They are the well behaved epis which can be
thought of as quotient maps. In fact, if $f : \asm{S} \to \asm{T}$ is
a regular epi, we say that $\asm{T}$ is a \defemph{quotient} of~$\asm{S}$.

The match between regular epis and quotients is precise in $\AsmA$.
Note that that in the construction of coequalizers, as described
above, we may start with an arbitrary equivalence relation: given an
assembly $\asm{T}$ and an equivalence relation $\equiv$ on~$T$, define
the \defemph{quotient assembly} $\asm{T}/{\equiv} = (T/{\equiv}, |T|,
\rz_{T/{\equiv}})$ whose realizability relation satisfies $\R{x}
\rz_{T/{\equiv}} [y]$ if, and only if, $\R{x} \rz_T x$ and $x \equiv
y$ for some $x \in T$. The quotient map $q : T \to T/{\equiv}$ is
realized by $\xpcalam{\annot{x}{|T|}}{x}$, and is a coequalizer of $g,
h : \asm{V} \to \asm{T}$ where\sidenote{You should convince yourself
  that $\asm{V}$ is the \defemph{kernel pair} of~$q$, i.e., the pullback
  of $q$ with itself.}
%
\begin{align*}
  \asm{V} &= (\set{(x,y) \in T \times T \such x \equiv y},
             |T| \times |T|, {\rz_V}),\\
  \combPair\;\R{x}\;\R{y} \rz_V (x,y) &\iff
  \R{x} \rz_T x \land \R{y} \rz_T y, \\
  g (x, y) &= x,\\
  h (x, y) &= y.
\end{align*}
%
Every regular epi is isomorphic to one of this form. To see this,
suppose $f : \asm{T} \to \asm{U}$ is a coequalizer of $g, h : \asm{U}
\to \asm{T}$. Let $\equiv$ be the least equivalence relation on~$T$
such that $g(x) = h(x)$ for all $x \in U$. Then $f$ is isomorphic to
$q : \asm{T} \to \asm{T}/{\equiv}$ because $g : \asm{T} \to
\asm{T}/{\equiv}$ is the coequalizer of $g$ and $h$ according to
Section~\ref{sec:cocartesian-structure}.

There is another characterization of regular epis which is used often.

\begin{proposition}
  \label{prop:reg-epi-when}%
  in $\AsmA$ a morphism $f : \asm{T} \to \asm{U}$ is a regular epi
  if, and only if, there exists $\R{i} \in \compAtyp{|U| \to |T|}$
  such that, whenever $\R{y} \rz_U y$ then $\defined{\R{i}\;\R{y}}$
  and there is $x \in f^{-1}(y)$ such that $\R{i}\;\R{y} \rz_T x$.
\end{proposition}

\begin{proof}
  In Section~\ref{sec:multi-valued-functions} we will see that $\R{i}$
  is a realizer for a multi-valued right inverse of~$f$, while
  in Section~\ref{sec:logical-reg-epi} we will see that $\R{i}$ is a
  realizer for the internal statement
  $\xall{y}{\asm{S}}{\xsome{x}{\asm{T}}{f(x) = y}}$. For the moment we
  just concentrate on the proof.

  Suppose first that we have a regular epi $f : \asm{T} \to \asm{U}$
  which is a coequalizer of~$g, h : \asm{S} \to \asm{T}$. Let $q :
  \asm{T} \to \asm{T}/{\equiv}$ be the coequalizer of~$g$ and~$h$, as
  computed in Section~\ref{sec:cocartesian-structure}. Because~$f$ and
  $q$ both equalize $g$ and $h$, there exists a unique isomorphism $i
  : \asm{U} \to \asm{T}/{\equiv}$ such that $q = i \circ f$. Let
  $\R{i} \in \compAtyp{|U| \to |T|}$ be a realizer for~$i$. We claim
  that it has the required properties. If $\R{y} \rz_U y$ then
  $\defined{\R{i}\;\R{y}}$ and $\R{i}\;\R{y} \rz_{T/{\equiv}} i(y)$.
  Because $f$ is surjective there exists $x' \in T$ such that $f(x') =
  y$, from which we get $i(y) = i(f(x')) = q(x') = [x']$. Since
  $\R{i}\;\R{y} \rz_{T/{\equiv}} [x']$ there is $x \in T$ such that
  $\R{i}\;\R{y} \rz_T x$ and $x \equiv x'$. The element~$x$ is the one
  we are looking for because $x \equiv x'$ implies $f(x) = f(x') = y$.

  Conversely, suppose $\R{i}$ is as in the statement of the
  proposition, and let $\R{f}$ be a realizer for~$f$. To show that $f
  : \asm{T} \to \asm{U}$ is a coequalizer, define the equivalence
  relation $\equiv$ on~$T$ by
  %
  \begin{equation*}
    x \equiv y \iff f(x) = f(y).
  \end{equation*}
  %
  It suffices to show that~$f$ is isomorphic to $q : \asm{T} \to
  \asm{T}/{\equiv}$. In one direction we have the map $j : T/{\equiv}
  \to U$ defined by $j([x]) = f(x)$, realized by $\R{f}$. In the other
  direction we have $i : U \to T/{\equiv}$ defined by $i(f(x)) = [x]$,
  which is well defined because~$f$ is surjective. The map $i$ is
  realized by~$\R{i}$. It is obvious that $i$ and $j$ are inverses of
  each other and that $q = i \circ f$ holds.
\end{proof}

\section{The regular structure}
\label{sec:regular-structure}

In the category of sets every function $f : S \to T$ may be factored
as $f = e \circ m$ where $e$ is epi and $m$ is mono. Similarly, a
continuous map between topological spaces may be factored into a
regular epi and a mono.

In assemblies a realized map $f : \asm{S} \to \asm{T}$ factors as
%
\begin{equation*}
  \xymatrix{
    {\asm{S}}
    \ar[rrr]^{f}
    \ar[rd]_{q}
    &
    &
    &
    {\asm{T}}
    \\
    &
    {\asm{U}}
    \ar[r]_{b}
    &
    {\asm{V}}
    \ar[ru]_{i}
    &
  }
\end{equation*}
%
where $q$ is a regular epi, $b$ is a mono-epi and $i$ is a regular
mono. Indeed, we may take $\asm{U} = \asm{S}/{\equiv}$, where $x
\equiv y \iff f(x) = f(y)$, and $q : \asm{S} \to \asm{S}/{\equiv}$ the
canonical quotient map. The assembly $\asm{V}$ is the restriction
of~$\asm{T}$ to the subset $V = \set{y \in T \such \xsome{x}{S}{f(x) =
    y}}$ so that $|V| = |T|$ and $\R{y} \rz_V y \iff \R{y} \rz_T y$
for all $y \in V$. The map $i : V \to T$ is the subset inclusion.
Finally, $b : U \to V$ is characterized by $b([x]_{\equiv}) = f(x)$.
It is realized by the same realizers as~$f$.

In the above factorization we call $\asm{U}$ the \defemph{image} of~$f$
and $\asm{V}$ the \defemph{stable image} of~$f$. The reason for the
terminology is revealed in Section~\ref{internal-epi-reg-epi}, where
the stable image is related to stable propositions.

The factorization is unique up to isomorphism. Suppose we had another
factorization $f = i' \circ b' \circ q'$ where $i'$, $b'$ and $q'$ are
regular mono, mono-epi, and regular-epi, respectively. We claim that
there are unique isomorphisms $j$ and $k$ which make the following
diagram commute:
%
\begin{equation*}
  \xymatrix{
    {\asm{S}}
    \ar[rrr]^{f}
    \ar[rd]^{q}
    \ar[rdd]_{q'}
    &
    &
    &
    {\asm{T}}
    \\
    &
    {\asm{U}}
    \ar[r]^{b}
    \ar[d]^{j}
    &
    {\asm{V}}
    \ar[ru]^{i}
    \ar[d]_{k}
    &
    \\
    &
    {\asm{U}'}
    \ar[r]_{b'}
    &
    {\asm{V}'}
    \ar[ruu]_{i'}
    &    
  }
\end{equation*}
%
Without loss of generality we may assume that $q'$ is a canonical
quotient map $q' : \asm{S} \to \asm{S}/{\equiv'}$ for an equivalence
relation~$\equiv'$ on~$S$, and that $i' : V' \to T$ is a subset
inclusion.

First we show that $\equiv$ and $\equiv'$ coincide. If $x \equiv y$
then $i'(b'(q'(x))) = f(x) = f(y) = i'(b'(q'(y)))$, and since $i'
\circ b'$ is a mono $q'(x) = q'(y)$ and $x \equiv' y$ follows.
Conversely, if $x \equiv' y$ then $q'(x) = q'(y)$ and $f(x) =
i'(b'(q'(x))) = i'(b'(q'(y))) = f(y)$, hence $x \equiv y$.

Next we verify that $V$ and $V'$ are equal. If $y \in V$ then $f(x) =
y$ for some $x \in S$. Because $y = f(x) = i'(b'(q'(x)))$ and $i'$ is
a subset inclusion, $b'(q'(x)) = f(x) = y$, which shows that $y \in
V'$. Conversely, if $y \in V'$ then there is $x \in S$ such that $y =
i'(b'(q'(x))) = f(x)$, but then $y \in V$.

Good factorization properties of $\AsmA$ lead to another important
feature of assemblies.

\begin{proposition}
  \label{prop:asm-regular}%
  The category $\AsmA$ is \defemph{regular},\sidenote{Note that there are
    several definitions of ``regular category'', but they all agree
    once we assume the existence of finite limits.} which means that
  %
  \begin{enumerate}
  \item it is cartesian,
  \item every morphism can be factored as a composition of a regular
    epi and a mono, and
  \item the pullback of a regular epi is a regular epi.
  \end{enumerate}
\end{proposition}

\begin{proof}
  The first item was proved in Proposition~\ref{prop:asm-cartesian}.
  For the second item, take the above factorization $f = i \circ b
  \circ q$ and notice that $q$ is a regular epi and $i \circ b$ a
  mono. Lastly, suppose $q : \asm{T} \to \asm{T}/{\equiv}$ is a
  regular epi, where we assumed without loss of generality that it is
  a quotient by an equivalence relation. Let $f : \asm{S} \to
  \asm{T}/{\equiv}$ be realized by~$\R{f} \in \compAtyp{|S| \to |T|}$.
  The pullback of~$q$ is the map $r : \asm{P} \to \asm{S}$, as in the
  diagram
  %
  \begin{equation*}
    \xymatrix{
      {\asm{P}} \pbcorner
      \ar[r]
      \ar[d]_{r}
      &
      {\asm{T}}
      \ar[d]^{q}
      \\
      {\asm{S}}
      \ar[r]_{f}
      &
      **[r]{\asm{T}/{\equiv}}
      }
  \end{equation*}
  %
  where
  %
  \begin{equation*}
    \asm{P} = (\set{(x,y) \in S \times T \such f(x) \equiv y},
               |S| \times |T|, {\rz_P}),
  \end{equation*}
  %
  $\combPair\;\R{x}\;\R{y} \rz_P (x,y)$ if, and only if, $\R{x} \rz_S
  x$ and $\R{y} \rz_T y$ and $r : (x,y) \mapsto x$. Let us use
  Proposition~\ref{prop:reg-epi-when} to show that~$r$ is regular epi.
  The realizer $\R{i} =
  \pcalam{\annot{x}{|S|}}{\combPair\;x\;(\R{f}\;x)}$ satisfies the
  conditions of the proposition: if $x \in S$ and $\R{x} \rz_S x$ then
  $\R{i}\;\R{x} = \combPair\;\R{x}\;(\R{f}\;\R{x})$ is defined. There
  is $y \in T$ such that $f(x) = [y]_{\equiv}$, hence $r (x, y) = x$,
  and also $\R{i}\;\R{x} \rz_P (x, y)$.
\end{proof}

The regular structure of assemblies is important for at least two
reasons: it gives a well-defined notion of an image of a realized map,
and it provides an interpretation of existential quantifiers, cf.\
Section~\ref{sec:realizability-interpretation}.


\section{Cartesian closed structure}
\label{sec:ccc}


If~$S$ and~$T$ are objects in a category, we may form the \emph{set}
$\Hom{S, T}$ of morphisms with domain $S$ and codomain $T$. Sometimes
$\Hom{S, T}$ carries additional structure that turns it into an object
of the category. For example, in the category of partially ordered
sets and monotone maps, the set $\Hom{P,Q}$ of monotone maps between
$(P, {\leq_P})$ and $(Q, {\leq_Q})$ is partially ordered by $f \leq g
\iff \xall{x}{P}{f(x) \leq_Q g(x)}$. The following definition explains
what it means for an object to correspond to the the set of morphisms.

\begin{definition}
  An \defemph{exponential} of objects $S$ and $T$ is an object $E$ with a
  morphism $e : E \times S \to T$, such that for every $f : U \times S
  \to T$ there exists a \emph{unique} $\curry{f} : U \to E$ such that
  the following diagram commutes:
  %
  \begin{equation*}
    \xymatrix@+0.5em{
      {E \times S}
      \ar[rd]^{e}
      &
      \\
      {U \times S}
      \ar[r]_{f}
      \ar[u]^{\curry{f} \times \id_S}
      &
      {T}
    }
  \end{equation*}
  %
  A category with finite products in which all exponentials exist is a
  \defemph{cartesian closed category (ccc)}.
\end{definition}

\noindent
%
The exponential is determined uniquely up to isomorphism. When given
as an operation, we denote the exponential of $S$ and $T$ by $T^S$,
and sometimes by $S \to T$. The map $e : T^S \times S \to T$ is called
the \defemph{evaluation morphism}. The map $\curry{f} : U \to T^S$ is
called the \defemph{transpose} of $f : U \times S \to T$.

Let us explain how exponentials work in the category of sets. The
exponential of sets $S$ and $T$ is the set
%
\begin{equation*}
  T^S = \set{f \such \text{$f$ is a function from $S$ to $T$}}
\end{equation*}
%
and the evaluation map is $e(f,x) = f(x)$. The transpose of $f : U
\times S \to T$ is $\curry{f}(z)(x) = f (z, x)$. This way the diagram
commutes because $e((\curry{f} \times \id_S)(z, x)) = e(\curry{f}(z),
x) = \curry{f}(z)(x) = f(z,x)$. The transpose $\curry{f}$ is the only
map satisfying this property.

\begin{proposition}
  \label{prop:asm-ccc}%
  The categories $\AsmA$ and $\ModA$ are cartesian closed.
\end{proposition}

\begin{proof}
  We prove that $\AsmA$ has exponentials. The same construction works
  for modest sets. Suppose~$\asm{S}$ and~$\asm{T}$ are assemblies.
  Define the assembly
  %
  \begin{equation*}
    \asm{T}^{\asm{S}} =
    (\set{f : S \to T \such \text{$f$ is realized}},
     |S| \to |T|, {\rz_{S \to T}})
  \end{equation*}
  %
  where
  %
  \begin{equation*}
    \R{f} \rz_{S \to T} f
    \iff
    \xall{x}{S}{
      \all{\R{x}}{|S|}{
          \R{x} \rz_S x \implies
          \defined{\R{f}\;\R{x}} \land
          \R{f}\;\R{x} \rz_T f(x)
        }
      }.
  \end{equation*}
  %
  None of this is surprising because we just copied the definition of
  realized maps. The evaluation map $e : \asm{T}^{\asm{S}} \times
  \asm{S} \to \asm{T}$ is $e(f, x) = f(x)$, which is realized by
  %
  \begin{equation*}
    \R{e} = \pcalam{\annot{p}{(|S| \to |T|) \times |S| \to
      |T|}}{(\combFst\;p)\;(\combSnd\;p)}.
  \end{equation*}
  %
  The transpose of $f : \asm{U} \times \asm{S} \to \asm{T}$, realized
  by $\R{f}$, is the map $\curry{f}(z)(x) = f(z,x)$, which is realized
  by
  %
  \begin{equation*}
    \R{\curry{f}} = \pcalam{\annot{z}{|U|} \; \annot{x}{|S|}}{
      \R{f}\;(\combPair\;z\;x)
    }.
  \end{equation*}
\end{proof}

The passage from $f : \asm{U} \times \asm{S} \to \asm{T}$ to its
transpose $\curry{f} : \asm{U} \to \asm{T}^{\asm{S}}$ has an inverse.
To every $g : \asm{U} \to \asm{T}^{\asm{S}}$ we may assign
$\uncurry{g} : \asm{U} \times \asm{S} \to \asm{T}$, defined by
$\uncurry{g}(z,x) = g(z)(x)$. If $g$ is realized by $\R{g}$ then
$\uncurry{g}$ is realized by $\uncurry{\R{g}} = \pcalam{\annot{p}{|U|
    \times |S|}}{\R{g}\;(\combFst\;p)\;(\combSnd\;p)}$. It is easy to
check that $\uncurry{\curry{f}} = f$ and $\curry{\uncurry{g}} = g$.
The operation $f \mapsto \curry{f}$ is also known as \defemph{currying}
and its inverse $g \mapsto \uncurry{g}$ as \defemph{uncurrying}.

Currying and uncurrying are useful operations, but the above notation
with ``hats and checks'' is not very practical. We may take better
advantage of the cartesian closed structure of $\AsmA$ by interpreting
the $\lambda$-calculus in it. The types of the $\lambda$-calculus are
the assemblies, where the product and function types are interpreted
as products and exponentials of assemblies, respectively. The unit
type is the terminal assembly~$\one$. The expressions are those of the
$\lambda$-calculus, except that we write the projections as $\pi_1$
and $\pi_2$ instead of $\combFst$ and $\combSnd$, respectively. In
addition if $\asm{T}$ is an assembly and $a \in T$ is an element for
which there exits a realizer $\R{a} \in \compAtyp{|T|}$ then~$a$ is a
primitive constant of type~$\asm{T}$.

Suppose $e$ is an expression of type~$\asm{T}$ and the freely
occurring variables of~$e$ are among $\annot{x_1}{\asm{S}_1}, \ldots,
\annot{x_n}{\asm{S}_n}$. We prefer to write the list of variables as
$x_1 : \asm{S}_1, \ldots, x_n : \asm{S}_n$, which we abbreviate as
$\overline{x} : \overline{\asm{S}}$, and call it a \defemph{typing
  context} for~$e$. The expression with the typing context determines
a realized map
%
\begin{equation*}
  \sem{\overline{x} : \overline{\asm{S}} \ctx e : \asm{T}} :
  \asm{S}_1 \times \cdots \times \asm{S}_n \to \asm{T},
\end{equation*}
%
which we abbreviate to $\sem{e}$ when no confusion may arise. We
define the meaning of $\sem{e}$ inductively on the structure of~$e$ as
follows, where $a = (a_1, \ldots, a_n) \in S_1 \times \cdots \times
S_n$:
%
\begin{enumerate}
\item A primitive constant $b \in \asm{T}$ which is realized by $\R{b}
  \in \compAtyp{|T|}$ is interpreted as the constant map
  %
  \begin{equation*}
    \sem{\overline{x} : \overline{\asm{S}} \ctx b : \asm{T}}(a) = b,
  \end{equation*}
  %
  which is realized\sidenote{Had we allowed as primitive constants
    \emph{all} elements of~$\asm{T}$, we would face a difficulty here,
    because we could not exhibit a computable realizer for the
    constant map.} by $\xpcalam{\annot{x}{|S_1| \times \cdots \times
      |S_n|}}{\R{b}}$.
\item A variable $\annot{x_i}{\asm{S}_i}$ is interpreted as the $i$-th
  projection
  %
  \begin{equation*}
    \sem{\overline{x} : \overline{\asm{S}} \ctx x_i : \asm{S}_i}(a) = a_i.
  \end{equation*}
  %
  which of course is realized.
\item A $\lambda$-abstraction $\xtlam{y}{\asm{U}}{e}$ of type $\asm{U}
  \to \asm{T}$ is interpreted as the realized map
  $\sem{\xtlam{y}{\asm{U}}{e}} : \asm{S}_1 \times \cdots \times
  \asm{S}_n \to \asm{T}^{\asm{U}}$ that is obtained as the transpose
  of
  %
  \begin{equation*}
    \xymatrix@+2em{
      **[l]{\asm{S}_1 \times \cdots \times \asm{S}_n \times \asm{U}}
      \ar[r]^{\sem{\overline{x}:\overline{\asm{S}}, y : \asm{U} \ctx e
        : \asm{T}}}
      &
      {\asm{T}}
    }
  \end{equation*}
  %
\item The interpretation of an application $e_1\;e_2$, where $e_1$ has
  type $\asm{U} \to \asm{T}$ and $e_2$ has type $\asm{U}$, is the map
  %
  \begin{equation*}
    \xymatrix@+2em{
      **[l]{\asm{S}_1 \times \cdots \times \asm{S}_n}
      \ar[r]^{\pair{\sem{e_1}, \sem{e_2}}}
      &
      {\asm{T}^{\asm{U}} \times \asm{U}}
      \ar[r]^{\mathsf{ev}}
      &
      {\asm{T}}      
    }
  \end{equation*}
  %
  where $\mathsf{ev}$ is the evaluation map.
\item The interpretation of a pair $(e_1, e_2)$ of type $\asm{T}
  \times \asm{U}$ is the map
  %
  \begin{equation*}
    \xymatrix@+2em{
      **[l]{\asm{S}_1 \times \cdots \times \asm{S}_n}
      \ar[r]^{\pair{\sem{e_1}, \sem{e_2}}}
      &
      {\asm{T} \times \asm{U}}
    }
  \end{equation*}
  %
\item A projection $\pi_1(e)$ of type $\asm{T}$, where $e$ has type
  $\asm{T} \times \asm{U}$, is the map
  %
  \begin{equation*}
    \xymatrix@+2em{
      **[l]{\asm{S}_1 \times \cdots \times \asm{S}_n}
      \ar[r]^{\sem{e}}
      &
      {\asm{T} \times \asm{U}}
      \ar[r]^{\pi_1}
      &
      {\asm{T}}
    }
  \end{equation*}
  %
  The second projection $\pi_2$ is treated analogously.
\end{enumerate}
%
This definition shows that we may freely use $\lambda$-calculus to
define realized maps. Although the definition tells us exactly how to
compute the realizers from the expressions, the idea is to \emph{not}
do that. We have verified once and for all that any map defined by
$\lambda$-calculus is realized, and in most cases we do not care which
specific realizer is used.

When $e$ is a closed expression of type $\asm{S}$ and the typing
context $\overline{x} : \overline{\asm{S}}$ is an empty list, the
meaning of $e$ is a realized map
%
\begin{equation*}
  \sem{{\cdot} \ctx e : \one \to \asm{T}}
\end{equation*}
%
which amounts to the same thing as an element of $\asm{T}$. This
element has a computable realizer, i.e., one in $\compAtyp{|T|}$,
because the corresponding realized map does.

We may further simplify the notation by allowing \emph{patterns} in
$\lambda$-abstraction, a technique commonly used in functional
programming languages. Instead of
%
\begin{equation*}
  \xtlam{p}{\asm{S} \times \asm{T}}{\ldots}
\end{equation*}
%
we write
%
\begin{equation*}
  \xtlam{(x,y)}{\asm{S} \times \asm{T}}{\ldots}
\end{equation*}
%
and replace each occurrence of $\combFst\;p$ by $x$, of $\combSnd\;p$
by $y$, and all other occurrences of~$p$ by $(x,y)$. For instance, we
would write
%
\begin{equation*}
  \xtlam{(f,g)}{(\asm{T} \to \asm{U}) \times (\asm{S} \to \asm{T})}{
    \xtlam{x}{\asm{S}}{f\;(g\;x)}}
\end{equation*}
%
instead of
%
\begin{equation*}
  \xtlam{p}{(\asm{T} \to \asm{U}) \times (\asm{S} \to \asm{T})}{
    \xtlam{x}{\asm{S}}{(\combFst\;p)\;(\combSnd\;p)\;x}}.
\end{equation*}
%
It is also useful to write the definition of a function as
%
\begin{equation*}
  f\;x_1\;\ldots\; x_n = e
\end{equation*}
%
instead of
%
\begin{equation*}
  f = \xulam{x_1\;\ldots\; x_n}{e}.
\end{equation*}

When $\AsmA$ has coproducts, and in most cases of interest it does,
the $\lambda$-calculus may be extended further to encompass binary
sums. If $\asm{S}$ and $\asm{T}$ are assemblies, viewed as types, then
we have the following expressions:
%
\begin{enumerate}
\item If $e$ is an expressions of type $\asm{S}$ then
  $\iota_1^{\asm{S},\asm{T}}(e)$ is an expression of type $\asm{S} +
  \asm{T}$. It is interpreted as the composition
  %
  \begin{equation*}
    \xymatrix{
      **[l]{\asm{S}_1 \times \cdots \times \asm{S}_n}
      \ar[r]^{\sem{e}}
      &
      {\asm{S}}
      \ar[r]^{\iota_1}
      &
     **[r]{\asm{S} + \asm{T}}
    }
  \end{equation*}
  %
  where $\iota_1$ is the canonical inclusion. The expression
  $\iota_2^{\asm{S},\asm{T}}(e)$ is treated similarly. We usually omit
  supscripts $\asm{S}, \asm{T}$ on $\iota_1$ and $\iota_2$.
\item If $e_1$ has type $\asm{S} + \asm{T}$, and $e_2$ and $e_3$ have
  type $\asm{U}$, then
  %
  \begin{equation*}
    \case{e_1}{\iota_1(x)}{e_2}{\iota_2(y)}{e_3}
  \end{equation*}
  %
  is an expression of type $\asm{U}$, with $x$ bound in $e_2$ and
  $y$ bound in $e_3$. It is interpreted as the composition
  %
  \begin{equation*}
    \xymatrix@+3em{
      **[l]{\asm{S}_1 \times \cdots \times \asm{S}_n}
      \ar[r]^{\sem{e_1}}
      &
      {\asm{S} + \asm{T}}
      \ar[r]^{[\sem{e_2}, \sem{e_3}]}
      &
      {\asm{U}}
    }
  \end{equation*}
\end{enumerate}
%
The following equations hold:
%
\begin{align*}
  (\case{\iota_1(e)}{\iota_1(x)}{e_1}{\iota_2(y)}{e_2}) &=
  \subst{e_1}{x \subto e}, \\
  (\case{\iota_2(e)}{\iota_1(x)}{e_1}{\iota_2(y)}{e_2}) &=
  \subst{e_2}{y \subto e}, \\
  (\case{e_1}
  {\iota_1(x)}{\subst{e_2}{z \subto \iota_1(x)}}
  {\iota_2(y)}{\subst{e_2}{z \subto \iota_2(y)}}
  ) &= \subst{e_2}{z \subto e_1}, \\
  \subst{e}{z \subto (\case{e_1}{\iota_1(x)}{e_2}{\iota_2(y)}{e_3})} &=
  \xcase{e_1}
  {\iota_1(x)}{\subst{e}{z \subto e_2}}
  {\iota_2(y)}{\subst{e}{z \subto e_3}}
\end{align*}

We conclude by using the cartesian closed structure of $\AsmA$ to
derive the distributive law
%
\begin{equation*}
  (\asm{S} + \asm{T}) \times \asm{U} \cong
  \asm{S} \times \asm{U} + \asm{T} \times \asm{U}.
\end{equation*}
%
Let us use the $\lambda$-calculus to write down the isomorphisms
explicitly. The isomorphism from left to right is
%
\begin{equation*}
  f = \xtlam{(a,b)}{(\asm{S} + \asm{T}) \times \asm{U}}{
    \xcase{a}
    {\iota_1(x)}{\iota_1(x, b)}
    {\iota_2(y)}{\iota_2(y, b)}
  }
\end{equation*}
%
and its inverse is
%
\begin{equation*}
  g = \xtlam{c}{(\asm{S} \times \asm{U}) + (\asm{T} \times \asm{U})}{
    \xcase{c}
    {\iota_1(x,b)}{(\iota_1(x), b)}
    {\iota_2(y,b)}{(\iota_2(y), b)}
  }
\end{equation*}
%
We compute
%
\begin{align*}
  g(f(a, b)) &=
  g(\case{a}
  {\iota_1(x)}{\iota_1(x, b)}
  {\iota_2(y)}{\iota_2(y, b)}) \\
  &=
  \xcase{a}
  {\iota_1(x)}{g(\iota_1(x, b))}
  {\iota_2(y)}{g(\iota_2(y, b))} \\
  &=
  \xcase{a}
  {\iota_1(x)}{(\iota_1(x), b)}
  {\iota_2(y)}{(\iota_2(y), b)} \\
  &=
  (a,b)
\end{align*}
%
and
\begin{align*}
  f(g(c)) &=
  f(
    \case{c}
    {\iota_1(x,b)}{(\iota_1(x), b)}
    {\iota_2(y,b)}{(\iota_2(y), b)}
  )
  \\
  &=
  \xcase{c}
  {\iota_1(x,b)}{f(\iota_1(x), b)}
  {\iota_2(y,b)}{f(\iota_2(y), b)}
  \\
  &=
  \xcase{c}
  {\iota_1(x,b)}{\iota_1(x, b)}
  {\iota_2(y,b)}{\iota_2(y, b)} \\
  &=
  c.
\end{align*}
%
This proof works in any cartesian closed category with binary
coproducts. In particular, it works in $\AsmA$. Notice how we need not
worry about the underlying realizers for the isomorphisms $f$ and $g$.
You are invited to redo the proof by drawing the relevant commutative
diagrams and using the universal properties of products, coproducts,
and exponentials.

\section{The natural numbers object}
\label{sec:natur-numb-object}


% When is a numbered set total





\section{Projective assemblies}
\label{sec:projective-assemblies}

% Presentation axiom

\begin{definition}
  An assembly is \defemph{canonically projective} if each element has
  precisely one realizer.
\end{definition}

\noindent
In symbols, an assembly $S$ is canonically projective when, for all
$x, y \in S$, $r \in A_{|S|}$,
%
\begin{equation*}
  r \rz_S x \land r \rz_S y \implies x = y.
\end{equation*}
%
The canonically projective assemblies are, up to isomorphism,
precisely the projective objects of the category of assemblies.

A canonically projective modest set $(S, |S|, {\rz_S})$ is determined,
up to isomorphism, by the set of the total realizers~$\|S\|$. This
follows from Lemma~\ref{lemma:iso-assembly} and the fact that
projectivity ensures that $S$ and $\|S\|$ are in bijective
correspondence. This combined with the fact that every modest set is a
quotient of a canonically projective one leads to the following
definition.

Let $\subcat{A, \comp{A}}$ be the category whose objects are pairs
$(S, |S|)$ where $|S|$ is a type and $S \subseteq A_{|S|}$. A morphism
$f : (S, |S|) \to (T, |T|)$ is a map $f : S \to T$ which is tracked by
some $p \in \comp{A}_{|S| \to |T|}$, i.e., for all $p \in S$,
$\defined{p\;r}$ and $p\;r \in T$. This category is equivalent to the
full subcategory of $\Mod{A, \comp{A}}$ on the canonically projective
modest sets.



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "notes-on-realizability"
%%% End:
